import { useEffect, useRef, useState } from "react";
import { compileTypescript, type ComponentFile } from "~/utils/compiler";
import { CursorArrowRaysIcon, ClockIcon } from "@heroicons/react/24/outline";
import { ActionHistoryPanel } from "./ActionHistoryPanel";
import { type ActionRecord } from "~/types/multimodal";

interface MyProps extends React.HTMLAttributes<HTMLDivElement> {
  code: ComponentFile[];
}

export const PageEditor = ({ code }: MyProps) => {
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const [dom, setDom] = useState<string | undefined>(undefined);
  const svgRef = useRef<SVGSVGElement>(null);
  const [dimensions, setDimensions] = useState({ width: 0, height: 0 });
  const [isElementSelectMode, setIsElementSelectMode] = useState(false);
  const [hoveredElement, setHoveredElement] = useState<HTMLElement | null>(
    null,
  );
  const [actionHistory, setActionHistory] = useState<ActionRecord[]>([]);
  const [showActionHistory, setShowActionHistory] = useState(false);

  // Ê∑ªÂä†Êìç‰ΩúËÆ∞ÂΩï
  const addActionRecord = (
    type: "click" | "rightclick" | "doubleclick",
    element: HTMLElement,
  ) => {
    const tagName = element.tagName.toLowerCase();
    const elementText = element.textContent?.trim().substring(0, 50) || "";
    const elementClass = element.className || "";
    const elementId = element.id || "";

    let description = `${
      type === "rightclick"
        ? "Âè≥ÈîÆÁÇπÂáª"
        : type === "doubleclick"
        ? "ÂèåÂáª"
        : "ÁÇπÂáª"
    } <${tagName}>`;

    if (elementId) {
      description += ` (id: ${elementId})`;
    } else if (elementClass) {
      description += ` (class: ${elementClass.split(" ")[0]})`;
    }

    if (elementText) {
      description += ` - "${elementText}"`;
    }

    const record: ActionRecord = {
      id: Math.random().toString(36).substring(2, 15),
      timestamp: Date.now(),
      type,
      elementTag: tagName,
      elementText,
      elementClass,
      elementId,
      description,
    };

    console.log("üöÄ ~ addActionRecord ~ record:", record); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
    setActionHistory((prev) => [record, ...prev].slice(0, 50)); // ‰øùÊåÅÊúÄËøë50Êù°ËÆ∞ÂΩï
  };

  // Ê∑ªÂä†iframe‰∫ã‰ª∂ÁõëÂê¨Âô®
  const addIframeEventListeners = () => {
    const iframe = iframeRef.current;
    if (!iframe?.contentDocument) {
      console.log("üöÄ ~ iframe contentDocument not ready"); // Ë∞ÉËØïÊó•Âøó
      return null;
    }

    const iframeDoc = iframe.contentDocument;
    console.log("üöÄ ~ Adding iframe event listeners"); // Ë∞ÉËØïÊó•Âøó

    // ÁÇπÂáª‰∫ã‰ª∂
    const handleIframeClick = (e: MouseEvent) => {
      console.log("üöÄ ~ iframe click detected", e.target); // Ë∞ÉËØïÊó•Âøó
      if (isElementSelectMode) return; // ÈÄâÊã©Ê®°Âºè‰∏ã‰∏çËÆ∞ÂΩï

      const target = e.target as HTMLElement;
      if (
        target &&
        target !== iframeDoc.body &&
        target !== iframeDoc.documentElement
      ) {
        addActionRecord("click", target);
      }
    };

    // Âè≥ÈîÆÁÇπÂáª‰∫ã‰ª∂
    const handleIframeContextMenu = (e: MouseEvent) => {
      console.log("üöÄ ~ iframe contextmenu detected", e.target); // Ë∞ÉËØïÊó•Âøó
      if (isElementSelectMode) return; // ÈÄâÊã©Ê®°Âºè‰∏ã‰∏çËÆ∞ÂΩï

      const target = e.target as HTMLElement;
      if (
        target &&
        target !== iframeDoc.body &&
        target !== iframeDoc.documentElement
      ) {
        addActionRecord("rightclick", target);
      }
    };

    // ÂèåÂáª‰∫ã‰ª∂
    const handleIframeDoubleClick = (e: MouseEvent) => {
      console.log("üöÄ ~ iframe dblclick detected", e.target); // Ë∞ÉËØïÊó•Âøó
      if (isElementSelectMode) return; // ÈÄâÊã©Ê®°Âºè‰∏ã‰∏çËÆ∞ÂΩï

      const target = e.target as HTMLElement;
      if (
        target &&
        target !== iframeDoc.body &&
        target !== iframeDoc.documentElement
      ) {
        addActionRecord("doubleclick", target);
      }
    };

    iframeDoc.addEventListener("click", handleIframeClick, true); // ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµ
    iframeDoc.addEventListener("contextmenu", handleIframeContextMenu, true);
    iframeDoc.addEventListener("dblclick", handleIframeDoubleClick, true);

    return () => {
      console.log("üöÄ ~ Removing iframe event listeners"); // Ë∞ÉËØïÊó•Âøó
      iframeDoc.removeEventListener("click", handleIframeClick, true);
      iframeDoc.removeEventListener(
        "contextmenu",
        handleIframeContextMenu,
        true,
      );
      iframeDoc.removeEventListener("dblclick", handleIframeDoubleClick, true);
    };
  };

  useEffect(() => {
    // Compile and render the page
    const compileCode = async () => {
      const compiledCode = await compileTypescript(code);
      setDom(compiledCode);
    };

    // We resize the canvas to fit the screen. This is not ideal, but it works for now.
    const handleResize = () => {
      const iframe = iframeRef.current;
      if (!iframe) return;
      const { contentWindow } = iframeRef.current;
      if (contentWindow) {
        const { documentElement } = contentWindow.document;
        const width = documentElement.clientWidth;
        const height = documentElement.clientHeight;
        setDimensions({ width, height });
      }
    };
    handleResize();
    window.addEventListener("resize", handleResize);

    // Compile the code
    compileCode();

    return () => {
      window.removeEventListener("resize", handleResize);
    };
  }, [code]);

  // ÂçïÁã¨ÁöÑuseEffectÊù•Â§ÑÁêÜiframe‰∫ã‰ª∂ÁõëÂê¨Âô®
  useEffect(() => {
    if (!dom) return; // Á°Æ‰øùDOMÂ∑≤ÁºñËØëÂÆåÊàê

    let cleanup: (() => void) | null = null;

    // ‰ΩøÁî®Â§öÊ¨°Â∞ùËØïÊù•Á°Æ‰øùiframeÂÆåÂÖ®Âä†ËΩΩ
    const attempts = [500, 1000, 2000, 3000]; // Â§ö‰∏™Êó∂Èó¥ÁÇπÂ∞ùËØï
    const timeouts: NodeJS.Timeout[] = [];

    attempts.forEach((delay) => {
      const timeout = setTimeout(() => {
        if (!cleanup) {
          // Âè™Âú®ËøòÊ≤°ÊúâÊàêÂäüÊ∑ªÂä†ÁõëÂê¨Âô®Êó∂Â∞ùËØï
          cleanup = addIframeEventListeners();
          if (cleanup) {
            console.log(
              "üöÄ ~ Successfully added iframe event listeners after",
              delay,
              "ms",
            );
          }
        }
      }, delay);
      timeouts.push(timeout);
    });

    return () => {
      // Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®
      timeouts.forEach(clearTimeout);
      // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
      if (cleanup) {
        cleanup();
      }
    };
  }, [dom, isElementSelectMode]); // ‰æùËµñdomÂíåÈÄâÊã©Ê®°ÂºèÁä∂ÊÄÅ

  // ÂêØÁî®ÂÖÉÁ¥†ÈÄâÊã©Ê®°Âºè
  const enableElementSelection = () => {
    setIsElementSelectMode(true);

    const iframe = iframeRef.current;
    if (!iframe?.contentDocument) return;

    const iframeDoc = iframe.contentDocument;

    // Ê∑ªÂä†ÈÄâÊã©Ê†∑Âºè
    const style = iframeDoc.createElement("style");
    style.textContent = `
      .element-selector-hover {
        outline: 2px solid #3b82f6 !important;
        outline-offset: 1px !important;
        cursor: crosshair !important;
      }
      .element-selector-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 9999 !important;
        cursor: crosshair !important;
      }
    `;
    iframeDoc.head.appendChild(style);

    // ÂàõÂª∫ÈÄèÊòéË¶ÜÁõñÂ±Ç
    const overlay = iframeDoc.createElement("div");
    overlay.className = "element-selector-overlay";
    iframeDoc.body.appendChild(overlay);

    let currentHoveredElement: HTMLElement | null = null;

    // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂
    const handleMouseMove = (e: MouseEvent) => {
      e.preventDefault();
      e.stopPropagation();

      // ‰∏¥Êó∂ÈöêËóèË¶ÜÁõñÂ±Ç‰ª•Ëé∑ÂèñÁúüÂÆûÂÖÉÁ¥†
      overlay.style.display = "none";
      const elementBelow = iframeDoc.elementFromPoint(
        e.clientX,
        e.clientY,
      ) as HTMLElement;
      overlay.style.display = "block";

      if (elementBelow && elementBelow !== currentHoveredElement) {
        // ÁßªÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
        if (currentHoveredElement) {
          currentHoveredElement.classList.remove("element-selector-hover");
        }

        // Ê∑ªÂä†Êñ∞ÁöÑÈ´ò‰∫ÆÔºà‰ΩÜ‰∏çÂåÖÊã¨bodyÂíåhtmlÔºâ
        if (
          elementBelow !== iframeDoc.body &&
          elementBelow !== iframeDoc.documentElement
        ) {
          elementBelow.classList.add("element-selector-hover");
          currentHoveredElement = elementBelow;
          setHoveredElement(elementBelow);
        } else {
          currentHoveredElement = null;
          setHoveredElement(null);
        }
      }
    };

    // Èº†Ê†áÁ¶ªÂºÄË¶ÜÁõñÂ±ÇÊó∂ÁßªÈô§È´ò‰∫Æ
    const handleMouseLeave = (e: MouseEvent) => {
      if (currentHoveredElement) {
        currentHoveredElement.classList.remove("element-selector-hover");
        currentHoveredElement = null;
        setHoveredElement(null);
      }
    };

    // ÁÇπÂáª‰∫ã‰ª∂
    const handleClick = (e: MouseEvent) => {
      e.preventDefault();
      e.stopPropagation();

      if (currentHoveredElement) {
        selectElement(currentHoveredElement);
      }

      disableElementSelection();
    };

    overlay.addEventListener("mousemove", handleMouseMove);
    overlay.addEventListener("mouseleave", handleMouseLeave);
    overlay.addEventListener("click", handleClick);

    // Ê∏ÖÁêÜÂáΩÊï∞
    const cleanup = () => {
      if (currentHoveredElement) {
        currentHoveredElement.classList.remove("element-selector-hover");
      }
      overlay.remove();
      style.remove();
    };

    // ‰øùÂ≠òÊ∏ÖÁêÜÂáΩÊï∞Âà∞iframe‰∏äÔºåÊñπ‰æøÂêéÁª≠Ë∞ÉÁî®
    (iframe as any).elementSelectorCleanup = cleanup;
  };

  // Á¶ÅÁî®ÂÖÉÁ¥†ÈÄâÊã©Ê®°Âºè
  const disableElementSelection = () => {
    setIsElementSelectMode(false);
    setHoveredElement(null);

    const iframe = iframeRef.current;
    if (iframe && (iframe as any).elementSelectorCleanup) {
      (iframe as any).elementSelectorCleanup();
      (iframe as any).elementSelectorCleanup = null;
    }
  };

  // ÈÄâÊã©ÂÖÉÁ¥†
  const selectElement = (element: HTMLElement) => {
    const tagName = element.tagName.toLowerCase();

    // ÁÆÄÂåñÂÖÉÁ¥†ÂêçÁß∞ÔºåÂè™ÊòæÁ§∫Ê†áÁ≠æÁ±ªÂûã
    const elementName = `<${tagName}>`;

    // ÂàõÂª∫Ëá™ÂÆö‰πâ‰∫ã‰ª∂ÔºåÈÄöÁü• RichTextInput ÁªÑ‰ª∂
    const event = new CustomEvent("elementDrop", {
      detail: {
        type: "element",
        name: elementName,
        content: element.outerHTML,
      },
    });
    window.dispatchEvent(event);
  };

  const handleScroll = (event: React.WheelEvent) => {
    if (!iframeRef.current) return;
    if (!iframeRef.current.contentWindow) return;
    iframeRef.current.contentWindow.scrollBy(0, event.deltaY);

    // scrollTop = iframeRef.current.scrollTop + event.deltaY;
  };

  return (
    <div className="absolute inset-0 flex justify-center">
      {/* Êìç‰ΩúÊåâÈíÆÁªÑ */}
      <div className="absolute right-4 top-4 z-10 flex space-x-2">
        {/* ÂéÜÂè≤ËÆ∞ÂΩïÊåâÈíÆ */}
        <button
          onClick={() => setShowActionHistory(!showActionHistory)}
          className={`
            inline-flex items-center rounded-md px-3 py-2 text-sm font-medium shadow-sm
            ${
              showActionHistory
                ? "bg-gray-600 text-white hover:bg-gray-700"
                : "bg-gray-500 text-white hover:bg-gray-600"
            }
          `}
          title={`${showActionHistory ? "ÈöêËóè" : "ÊòæÁ§∫"}Êìç‰ΩúÂéÜÂè≤ËÆ∞ÂΩï`}
        >
          <ClockIcon className="mr-1 h-4 w-4" />
          ÂéÜÂè≤ ({actionHistory.length})
        </button>

        {/* ÂÖÉÁ¥†ÈÄâÊã©ÊåâÈíÆ */}
        <button
          onClick={
            isElementSelectMode
              ? disableElementSelection
              : enableElementSelection
          }
          className={`
            inline-flex items-center rounded-md px-3 py-2 text-sm font-medium shadow-sm
            ${
              isElementSelectMode
                ? "bg-red-600 text-white hover:bg-red-700"
                : "bg-blue-600 text-white hover:bg-blue-700"
            }
          `}
          title={isElementSelectMode ? "ÂèñÊ∂àÈÄâÊã©ÂÖÉÁ¥† (ESC)" : "ÈÄâÊã©È°µÈù¢ÂÖÉÁ¥†"}
        >
          <CursorArrowRaysIcon className="mr-1 h-4 w-4" />
          {isElementSelectMode ? "ÂèñÊ∂àÈÄâÊã©" : "ÈÄâÊã©ÂÖÉÁ¥†"}
        </button>
      </div>

      {/* Êìç‰ΩúÂéÜÂè≤Èù¢Êùø */}
      {showActionHistory && (
        <ActionHistoryPanel
          actions={actionHistory}
          onClose={() => setShowActionHistory(false)}
          onClear={() => setActionHistory([])}
        />
      )}

      <div
        className="absolute inset-0 overflow-hidden rounded-b-lg"
        onWheel={handleScroll}
      >
        <iframe
          width="100%"
          height="100%"
          tabIndex={-1}
          title="The editor's rendered HTML document"
          srcDoc={dom}
          ref={iframeRef}
          className="mx-auto my-0 block w-full min-w-[769] overflow-hidden border-0"
        />
        <div className="pointer-events-none absolute inset-y-0 flex max-w-full">
          <svg
            id="SVGOverlay"
            className="overflow-visible"
            width={dimensions.width}
            height={dimensions.height}
            ref={svgRef}
          >
            <rect id="SVGSelection"></rect>
            <rect id="SVGHover"></rect>
          </svg>
        </div>
      </div>
    </div>
  );
};
